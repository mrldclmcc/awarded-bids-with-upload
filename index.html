<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Awarded Bids Formatter v2.0</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f0f0f0;
            margin: 20px;
            color: #333;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border: 2px solid #1e3a5f;
            padding: 0;
        }

        .header {
            background-color: #1e3a5f;
            color: white;
            padding: 20px;
            text-align: center;
            border-bottom: 4px solid #f7931e;
        }

        .header h1 {
            margin: 0;
            font-size: 24px;
            font-weight: bold;
        }

        .header p {
            margin: 5px 0 0 0;
            font-size: 14px;
        }

        .content {
            padding: 20px;
        }

        .section {
            margin-bottom: 30px;
            border: 1px solid #ccc;
            background: #fafafa;
        }

        .section-header {
            background-color: #1e3a5f;
            color: white;
            padding: 10px 15px;
            margin: 0;
            font-size: 16px;
            font-weight: bold;
        }

        .section-content {
            padding: 15px;
        }

        .instructions {
            background-color: #fff3cd;
            border: 1px solid #f7931e;
            padding: 10px;
            margin-bottom: 15px;
        }

        .instructions p {
            margin: 5px 0;
        }

        .download-link {
            color: #f7931e;
            text-decoration: underline;
            cursor: pointer;
            font-weight: bold;
        }

        .download-link:hover {
            color: #e5821a;
        }

        #dataInput {
            width: 100%;
            height: 200px;
            font-family: "Courier New", monospace;
            font-size: 12px;
            border: 2px inset #ccc;
            padding: 10px;
            background: white;
        }

        #dataInput:focus {
            border-color: #f7931e;
            outline: none;
        }

        .button-row {
            text-align: center;
            margin: 15px 0;
        }

        button {
            background-color: #f7931e;
            color: white;
            border: 2px outset #f7931e;
            padding: 8px 20px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            margin: 0 5px;
        }

        button:hover {
            background-color: #e5821a;
        }

        button:active {
            border: 2px inset #f7931e;
        }

        #outputPreview {
            background: white;
            border: 2px inset #ccc;
            padding: 15px;
            min-height: 300px;
            font-family: Arial, sans-serif;
            font-size: 13px;
            line-height: 1.4;
            white-space: pre-wrap;
            overflow-y: auto;
        }

        .status {
            margin: 10px 0;
            padding: 8px;
            border: 1px solid;
            text-align: center;
            font-weight: bold;
        }

        .status.success {
            background-color: #d4edda;
            color: #155724;
            border-color: #c3e6cb;
        }

        .status.error {
            background-color: #f8d7da;
            color: #721c24;
            border-color: #f5c6cb;
        }

        .hidden {
            display: none;
        }

        table {
            border-collapse: collapse;
            width: 100%;
            margin: 10px 0;
        }

        th, td {
            border: 1px solid #ccc;
            padding: 5px;
            text-align: left;
            font-size: 11px;
        }

        th {
            background-color: #1e3a5f;
            color: white;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Awarded Bids Formatter v 2.0</h1>
            <p>Convert Excel data to email-ready format</p>
        </div>
        
        <div class="content">
            <div class="section">
                <div class="section-header">Step 1: Input Data</div>
                <div class="section-content">
                    <div class="instructions">
                        <p><strong>Instructions:</strong> Copy data from Excel and paste below. Include the header row. Or upload the Excel file. Use the format that Dashboard exports (but delete the top merged row first so that actual headers are now in the top row).</p>
                    </div>
                    
                    <textarea id="dataInput" placeholder="Paste your data here...



"></textarea>

<div class="button-row">
    <button onclick="processData()">Process Data</button>
    <button onclick="clearAll()">Clear All</button>

    <!-- Upload button (styled like a button) -->
    <label for="fileInput" style="display:inline-block;background:#f7931e;color:#fff;border:2px outset #f7931e;padding:8px 20px;font-size:14px;font-weight:bold;cursor:pointer;margin:0 5px;">
        Upload Spreadsheet
    </label>
    <input type="file" id="fileInput" accept=".xlsx" style="display:none;" onchange="handleFile(event)">
</div>
            
            <div class="section">
                <div class="section-header">Step 2: Formatted Output</div>
                <div class="section-content">
                    <div id="outputPreview">Your formatted output will appear here...</div>
                    <div class="button-row">
                        <button onclick="copyToClipboard()">Copy to Clipboard</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let processedData = '';

        function downloadTemplate() {
            const csvContent = "Local,Public Body,Project Name,Bid Award Amount,Bid Award Contractor,Project Street,Tentative Start Date\nLOCAL 225,Mount Prospect Park District,Lions Recreation Center Abatement,$198950.00,KIM CONSTRUCTION COMPANY INC,411 South Maple Street Mount Prospect IL 60056,9/4/25";
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', 'Awarded_Bids_Template.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showStatus('Template downloaded!', 'success');
        }

        function showStatus(message, type) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
            status.classList.remove('hidden');
            
            setTimeout(() => {
                status.classList.add('hidden');
            }, 3000);
        }

        function processData() {
            const input = document.getElementById('dataInput').value.trim();
            
            if (!input) {
                showStatus('Please paste some data first!', 'error');
                return;
            }

            try {
                const lines = input.split('\n').filter(line => line.trim());
                
                if (lines.length < 2) {
                    showStatus('Please include header and data rows.', 'error');
                    return;
                }

                // Build column index map (case-insensitive)
                const headers = lines[0].split('\t').map(h => h.trim().toLowerCase());
                const idx = {
                    local: headers.indexOf('local'),
                    publicBody: headers.indexOf('public body'),
                    projectName: headers.indexOf('project name'),
                    awardAmount: headers.indexOf('bid award amount'),
                    contractor: headers.indexOf('bid award contractor'),
                    location: headers.indexOf('project street'),
                    startDate: headers.indexOf('tentative start date')
                };

                // Ensure required columns exist
                if (Object.values(idx).includes(-1)) {
                    throw new Error('Missing required columns');
                }

                const dataRows = lines.slice(1)
                    .map(r => r.split('\t'))
                    // Filter out rows where Bid Award Contractor (index 23) and Bid Award Amount (index 24) are empty
                    .filter(cols => cols[23]?.trim() && cols[24]?.trim())
                    .map(cols => ({
                        local: cols[idx.local]?.replace(/^LOCAL\s*/i, '').trim() || '',
                        publicBody: cols[idx.publicBody]?.trim() || '',
                        projectName: cols[idx.projectName]?.trim() || '',
                        awardAmount: cols[idx.awardAmount]?.trim() || '',
                        contractor: cols[idx.contractor]?.trim() || '',
                        location: cols[idx.location]?.trim() || '',
                        startDate: formatDate(cols[idx.startDate] || '')
                    }));

                if (dataRows.length === 0) {
                    showStatus('No rows to process (all filtered out).', 'error');
                    return;
                }

                const groupedProjects = groupByLocal(dataRows);
                processedData = formatOutput(groupedProjects);
                
                document.getElementById('outputPreview').innerHTML = processedData;
                showStatus(`Processed ${dataRows.length} projects successfully!`, 'success');

            } catch (error) {
                showStatus('Error processing data. Check format.', 'error');
                console.error('Processing error:', error);
            }
        }

        function formatDate(dateStr) {
            if (!dateStr) return '';
            
            if (dateStr.includes('/')) {
                const parts = dateStr.split('/');
                if (parts.length === 3) {
                    const month = parts[0].padStart(2, '0');
                    const day = parts[1].padStart(2, '0');
                    let year = parts[2];
                    if (year.length === 2) {
                        year = '20' + year;
                    }
                    return `${month}/${day}/${year}`;
                }
            }
            
            return dateStr;
        }

        function groupByLocal(projects) {
            const groups = {};
            
            projects.forEach(project => {
                const local = project.local;
                if (!groups[local]) {
                    groups[local] = [];
                }
                groups[local].push(project);
            });
            
            return groups;
        }

        function formatOutput(groupedProjects) {
            let output = '';
            const locals = Object.keys(groupedProjects).sort((a, b) => {
                const numA = parseInt(a) || 0;
                const numB = parseInt(b) || 0;
                return numA - numB;
            });
            
            locals.forEach((local, groupIndex) => {
                const projects = groupedProjects[local];
                
                projects.forEach((project, projectIndex) => {
                    output += `<strong>Local:</strong> LOCAL ${project.local}<br>`;
                    output += `<strong>Public Body:</strong> ${project.publicBody}<br>`;
                    output += `<strong>Project:</strong> ${project.projectName}<br>`;
                    output += `<strong>Award Amount:</strong> ${project.awardAmount}<br>`;
                    output += `<strong>Awarded Contractor:</strong> ${project.contractor}<br>`;
                    output += `<strong>Project Location:</strong> ${project.location}<br>`;
                    output += `<strong>Estimated Start Date:</strong> ${project.startDate}<br>`;
                    
                    if (projectIndex < projects.length - 1) {
                        output += '<br>';
                    }
                });
                
                if (groupIndex < locals.length - 1) {
                    output += '<br>---<br><br>';
                }
            });
            
            return output;
        }

        async function copyToClipboard() {
            if (!processedData) {
                showStatus('No data to copy. Process data first.', 'error');
                return;
            }

            try {
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = processedData;
                
                if (navigator.clipboard && navigator.clipboard.write) {
                    const htmlBlob = new Blob([processedData], { type: 'text/html' });
                    const textContent = tempDiv.textContent || tempDiv.innerText || '';
                    const textBlob = new Blob([textContent], { type: 'text/plain' });
                    
                    const clipboardItem = new ClipboardItem({
                        'text/html': htmlBlob,
                        'text/plain': textBlob
                    });
                    
                    await navigator.clipboard.write([clipboardItem]);
                    showStatus('Copied to clipboard!', 'success');
                } else {
                    const textContent = tempDiv.textContent || tempDiv.innerText || '';
                    await navigator.clipboard.writeText(textContent);
                    showStatus('Copied (plain text)', 'success');
                }
            } catch (error) {
                showStatus('Copy failed. Select and copy manually.', 'error');
            }
        }

        function clearAll() {
            document.getElementById('dataInput').value = '';
            document.getElementById('outputPreview').innerHTML = 'Your formatted output will appear here...';
            processedData = '';
            showStatus('Data cleared.', 'success');
        }

        document.getElementById('dataInput').addEventListener('paste', function() {
            setTimeout(() => {
                if (this.value.trim()) {
                    processData();
                }
            }, 100);
        });
    </script>
    
<!-- SheetJS (small, MIT license) -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script>
function handleFile(evt) {
    const file = evt.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function (e) {
        try {
            const workbook = XLSX.read(e.target.result, { type: 'binary' });
            const sheetName = workbook.SheetNames[0];
            const sheet = workbook.Sheets[sheetName];
            // Convert to 2-D array (each row is an array of cells)
            const json = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: "" });

            // Re-create TSV string for existing parser
            const tsv = json.map(row => row.join('\t')).join('\n');
            document.getElementById('dataInput').value = tsv;
            processData();          // reuse current logic
        } catch (err) {
            showStatus('Error reading file.', 'error');
            console.error(err);
        }
    };
    reader.readAsBinaryString(file);
}
</script>
    
</body>
</html>
